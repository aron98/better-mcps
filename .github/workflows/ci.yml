name: CI

on:
  pull_request:

jobs:
  select-modules:
    runs-on: ubuntu-latest
    outputs:
      modules_json: ${{ steps.pick.outputs.modules_json }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Pick modules
        id: pick
        uses: ./.github/actions/select-modules
        with:
          manifest: .release-please-manifest.json
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.head.sha }}

      - name: Summary
        run: |
          echo "Selected modules: ${{ steps.pick.outputs.modules_json }}" >> "$GITHUB_STEP_SUMMARY"

  ci:
    needs: select-modules
    runs-on: ubuntu-latest

    steps:
      # Checkout `main` into a separate directory so local composite actions are always available,
      # even if this PR's HEAD commit does not include them.
      - name: Checkout actions (main)
        uses: actions/checkout@v4
        with:
          ref: main
          path: actions

      # Checkout the PR code under test.
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: repo

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Compute module paths
        id: module_paths
        run: |
          set -euo pipefail
          modules_json='${{ needs.select-modules.outputs.modules_json }}'
          echo "modules_json=$modules_json" >> "$GITHUB_STEP_SUMMARY"
          modules_paths_json=$(printf '%s' "$modules_json" | jq -c 'map("repo/" + .)')
          echo "modules_paths_json=$modules_paths_json" >> "$GITHUB_OUTPUT"
          echo "modules_paths_json=$modules_paths_json" >> "$GITHUB_STEP_SUMMARY"

      - name: Run module CI
        uses: ./actions/.github/actions/python-ci-multi
        with:
          modules_json: ${{ steps.module_paths.outputs.modules_paths_json }}
