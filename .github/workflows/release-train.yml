name: Release Train (bump PRs + tag on merge)

on:
  workflow_run:
    workflows: ["Python"]
    types: [completed]
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  # A) After successful CI on main, open bump PRs (one per package)
  bump-prs:
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install python-semantic-release
        run: python -m pip install --upgrade pip python-semantic-release

      - name: Find packages
        id: pkgs
        run: |
          set -euo pipefail
          PACKAGES=$(find . -mindepth 2 -name pyproject.toml -exec dirname {} \; \
            | sed 's|^\./||' \
            | sed 's|/.*$||' \
            | sort -u \
            | jq -R -s -c 'split("\n")[:-1]')
          echo "packages=$PACKAGES" >> "$GITHUB_OUTPUT"

      - name: Create bump PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Loop packages; if semantic-release says no release, skip.
          packages='${{ steps.pkgs.outputs.packages }}'
          echo "$packages" | jq -r '.[]' | while read -r pkg; do
            echo "=== $pkg ==="

            # Run semantic-release in the package dir but do not push/tag.
            # This updates files (pyproject, __init__.py, CHANGELOG) as configured.
            (cd "$pkg" && semantic-release version --no-push) || true

            # If no changes, skip.
            if git diff --quiet; then
              echo "No release changes for $pkg"
              git reset --hard
              continue
            fi

            # Create a branch name that is deterministic per pkg (force update).
            branch="release/${pkg}"

            git checkout -B "$branch"
            git add -A
            git commit -m "chore(release): bump ${pkg}"
            git push -f origin "$branch"

            # Create or update PR.
            existing=$(gh pr list --head "$branch" --base main --json number --jq '.[0].number' || true)
            if [ -n "$existing" ]; then
              echo "PR already exists for $pkg: #$existing"
            else
              gh pr create \
                --base main \
                --head "$branch" \
                --title "chore(release): bump ${pkg}" \
                --body "Automated version/changelog update for ${pkg}." \
                --label release
            fi

            # Enable auto-merge (will still respect required reviews).
            pr_num=$(gh pr list --head "$branch" --base main --json number --jq '.[0].number')
            gh pr merge "$pr_num" --auto --squash || true

            # Return to main branch working state.
            git checkout main
            git reset --hard
          done

  # B) On push to main, if a bump PR was merged, create tags
  tag-on-merge:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Tag any package version bumps in this merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Use https auth so tag push works with token
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Find package pyproject.toml files changed in the pushed commit range.
          # workflow_run merge commits will typically be single commit; push provides before/after.
          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          python scripts/tag_on_merge.py "$before" "$after"
