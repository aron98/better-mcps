name: Bump PRs (per package)

on:
  workflow_run:
    workflows: ["Python"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install python-semantic-release
        run: python -m pip install --upgrade pip python-semantic-release

      - name: Find packages
        id: pkgs
        run: |
          set -euo pipefail
          PACKAGES=$(find . -mindepth 2 -name pyproject.toml -exec dirname {} \; \
            | sed 's|^\./||' \
            | sed 's|/.*$||' \
            | sort -u \
            | jq -R -s -c 'split("\n")[:-1]')
          echo "packages=$PACKAGES" >> "$GITHUB_OUTPUT"

      - name: Create bump PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          packages='${{ steps.pkgs.outputs.packages }}'
          echo "$packages" | jq -r '.[]' | while read -r pkg; do
            echo "=== $pkg ==="

            # Determine last tag for this package.
            prefix="better-mcps-${pkg}-v"
            last_tag=$(git tag --list "${prefix}*" --sort=-creatordate | head -n 1 || true)
            if [[ -z "$last_tag" ]]; then
              since_ref=""
            else
              since_ref="$last_tag"
            fi

            bump=$(python scripts/bump_level.py "$pkg" "$since_ref")
            echo "bump=$bump (since ${since_ref:-<none>})"

            if [[ "$bump" == "none" ]]; then
              echo "No conventional bump for $pkg; skipping"
              continue
            fi

            # Run semantic-release to update files but do not push or tag.
            # This updates pyproject.toml, __init__.py, and CHANGELOG.md as configured.
            (cd "$pkg" && semantic-release version --"$bump" --no-push)

            if git diff --quiet; then
              echo "No changes produced for $pkg; skipping"
              git reset --hard
              continue
            fi

            branch="release/${pkg}"

            git checkout -B "$branch"
            git add -A
            git commit -m "chore(release): bump ${pkg}"
            git push -f origin "$branch"

            existing=$(gh pr list --head "$branch" --base main --json number --jq '.[0].number' || true)
            if [ -n "$existing" ]; then
              echo "PR already exists for $pkg: #$existing"
            else
              gh pr create \
                --base main \
                --head "$branch" \
                --title "chore(release): bump ${pkg}" \
                --body "Automated version/changelog update for ${pkg}." \
                --label release
            fi

            pr_num=$(gh pr list --head "$branch" --base main --json number --jq '.[0].number')
            # Enable auto-merge (will still respect required reviews)
            gh pr merge "$pr_num" --auto --squash || true

            git checkout main
            git reset --hard
          done
