name: Publish to PyPI (filesystem)

permissions:
  contents: read
  id-token: write

on:
  push:
    tags:
      - "better-mcps-filesystem-v*"

  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to publish (e.g. refs/tags/better-mcps-filesystem-v0.1.1). Leave empty to use the workflow run ref."
        required: false
        type: string

jobs:
  publish:
    environment: pypi
    runs-on: ubuntu-latest

    steps:
      # Checkout `main` into a separate directory so local composite actions are always available,
      # even when publishing an older tag that predates them.
      - name: Checkout actions (main)
        uses: actions/checkout@v4
        with:
          ref: main
          path: actions

      # Checkout the code to publish (tag/sha) into its own directory.
      - name: Checkout release ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}
          path: repo

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - uses: ./actions/.github/actions/python-ci-multi
        with:
          modules_json: '["repo/filesystem"]'

      - uses: ./actions/.github/actions/python-build
        with:
          module: repo/filesystem

      - uses: ./actions/.github/actions/pypi-publish
        with:
          dist_dir: repo/filesystem/dist
